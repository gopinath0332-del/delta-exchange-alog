//@version=5
strategy("RSI-Double-dip Long-Short (No Overlap) + ATR Partial + Trail + Alerts",
     overlay=true,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     pyramiding=0)

// ───── Inputs ─────
mode = input.string("Both", "Mode", options=["Long", "Short", "Both"])
allowLong  = mode == "Long"  or mode == "Both"
allowShort = mode == "Short" or mode == "Both"

rsiPeriod = input.int(14, "RSI Period")
rsiSource = input.source(close, "RSI Source")

longEntryLevel = input.float(50.0, "Long Entry RSI")
longExitLevel  = input.float(40.0, "Long Exit RSI")

shortEntryLevel = input.float(35.0, "Short Entry RSI")
shortExitLevel  = input.float(35.0, "Short Exit RSI")

requirePrevLongMinDuration = input.bool(true, "Require previous long duration?")
minDaysLong = input.int(2, "Min days long open", minval=0)

// ───── ATR Partial + Trailing Inputs ─────
atrLen        = input.int(14, "ATR Length")
atrMultTP     = input.float(4, "ATR Multiplier for Partial TP")
trailAtrMult  = input.float(4, "ATR Multiplier for Trailing Stop")
partialPct    = input.float(50, "Partial Exit Qty %", minval=1, maxval=99)

// ───── Indicators ─────
rsi = ta.rsi(rsiSource, rsiPeriod)
atr = ta.atr(atrLen)

// ───── Signals ─────
longSignal  = allowLong  and ta.crossover(rsi, longEntryLevel)
longExitSig = allowLong  and ta.crossunder(rsi, longExitLevel)

shortSignal  = allowShort and ta.crossunder(rsi, shortEntryLevel)
shortExitSig = allowShort and ta.crossover(rsi, shortExitLevel)

// ───── Time Tracking ─────
msPerDay = 24 * 60 * 60 * 1000

var float longEntryTime = na
var float lastLongDuration = 0.0

var int longTradeCounter = 0
var int shortUsedForLong = 0

inLong  = strategy.position_size > 0
inLongPrev = nz(strategy.position_size[1]) > 0

longOpened = inLong and not inLongPrev
longClosed = not inLong and inLongPrev

if longOpened
    longEntryTime := time

if longClosed
    lastLongDuration := not na(longEntryTime) ? time - longEntryTime : 0
    longEntryTime := na
    longTradeCounter += 1

// ───── Short Eligibility ─────
durationOK = not requirePrevLongMinDuration or
             lastLongDuration >= minDaysLong * msPerDay

shortAllowed =
     durationOK and
     (shortUsedForLong < longTradeCounter) and
     strategy.position_size == 0

// ───── Trade Execution (Original Logic) ─────
if longExitSig
    strategy.close("Long")

if shortExitSig
    strategy.close("Short")

if longSignal and strategy.position_size == 0
    strategy.entry("Long", strategy.long)

if shortSignal and shortAllowed
    strategy.entry("Short", strategy.short)
    shortUsedForLong := longTradeCounter

// ───── ATR Partial Profit Targets ─────
longTP  = strategy.position_avg_price + atr * atrMultTP
shortTP = strategy.position_avg_price - atr * atrMultTP

if strategy.position_size > 0
    strategy.exit("Long-Partial", from_entry="Long", limit=longTP, qty_percent=partialPct)

if strategy.position_size < 0
    strategy.exit("Short-Partial", from_entry="Short", limit=shortTP, qty_percent=partialPct)

// ───── ATR Trailing Stop for Remaining ─────
longTrail  = close - atr * trailAtrMult
shortTrail = close + atr * trailAtrMult

if strategy.position_size > 0
    strategy.exit("Long-Trail", from_entry="Long", stop=longTrail)

if strategy.position_size < 0
    strategy.exit("Short-Trail", from_entry="Short", stop=shortTrail)

// ───── Plot Levels ─────
plot(strategy.position_size > 0 ? longTP : na, "Long ATR Partial", color=color.green, style=plot.style_linebr)
plot(strategy.position_size > 0 ? longTrail : na, "Long ATR Trail", color=color.lime, style=plot.style_linebr)

plot(strategy.position_size < 0 ? shortTP : na, "Short ATR Partial", color=color.red, style=plot.style_linebr)
plot(strategy.position_size < 0 ? shortTrail : na, "Short ATR Trail", color=color.maroon, style=plot.style_linebr)

// ───── Alerts ─────
// Entry alerts
alertcondition(longSignal,  title="Long Entry",  message="Long Entry Signal")
alertcondition(shortSignal and shortAllowed, title="Short Entry", message="Short Entry Signal")

// Full exit alerts (RSI based)
alertcondition(longExitSig and strategy.position_size > 0,  title="Long Exit",  message="Long Exit Signal")
alertcondition(shortExitSig and strategy.position_size < 0, title="Short Exit", message="Short Exit Signal")

// Partial profit alerts (price touches TP)
alertcondition(strategy.position_size > 0 and high >= longTP,  title="Long Partial Exit",  message="Long Partial Profit Hit")
alertcondition(strategy.position_size < 0 and low  <= shortTP, title="Short Partial Exit", message="Short Partial Profit Hit")

// Trailing stop alerts (price touches trail)
alertcondition(strategy.position_size > 0 and low  <= longTrail,  title="Long Trailing Exit",  message="Long Trailing Stop Hit")
alertcondition(strategy.position_size < 0 and high >= shortTrail, title="Short Trailing Exit", message="Short Trailing Stop Hit")

// ───── Background ─────
bgcolor(strategy.position_size > 0 ? color.new(color.green, 85) : na)
bgcolor(strategy.position_size < 0 ? color.new(color.red, 85) : na)
